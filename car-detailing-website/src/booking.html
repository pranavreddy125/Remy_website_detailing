<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking — Desert Shine Detailing</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">Desert Shine Detailing</a>
      <button class="nav-toggle" aria-label="Toggle navigation"><span class="hamburger"></span></button>
      <nav class="main-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="payment.html">Payment</a></li>
          <li><a href="services.html">Services</a></li>
          <li><a class="active" href="booking.html">Booking</a></li>
          <li><a href="about.html">About Us</a></li>
        </ul>
      </nav>
      <div class="header-cta"><a class="btn signin" href="login.html">Sign In</a></div>
    </div>
  </header>

  <main class="container main-content">
    <section class="page-head">
      <h1>Book Your Appointment</h1>
      <p class="lead">Schedule your car detailing session with Desert Shine Detailing.</p>
    </section>

    <section class="booking-form">
      <div class="form-card">
        <form id="bookingForm" data-inline-handler="true">
        <p class="form-section-title">Contact Information</p>
        <label for="name">Full Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="phone">Phone Number:</label>
        <input type="tel" id="phone" name="phone" required>
        <div class="form-divider" aria-hidden="true"></div>

        <p class="form-section-title">Service Details</p>
        <label for="service">Select Service:
          <a class="info-link" href="services.html" aria-label="View service details">i</a>
        </label>
        <select id="service" name="service" required>
          <option value="">--Choose--</option>
          <option>Interior Detail</option>
          <option>Exterior Wash</option>
          <option>Full Detail</option>
        </select>
        

        <label for="notes">Notes (optional):</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
        <div class="form-divider" aria-hidden="true"></div>

        <p class="form-section-title">Schedule</p>
        <label for="date">Date:</label>
        <div class="date-picker" role="group">
          <input type="date" id="date" name="date" class="date-field" required inputmode="none">
          <button type="button" class="calendar-btn" aria-label="Open calendar picker">Select Date</button>
        </div>

        <label>Preferred Time:</label>
        <div class="time-row time-picker">
          <div class="time-input-wrapper">
            <input type="text" id="timeDisplay" class="time-display" placeholder="Select time" readonly required>
            <div class="time-dropdowns" id="timeDropdowns" aria-hidden="true">
              <select id="timeHourSelect" aria-label="Select hour">
                <option value="">Hour</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
              <select id="timeMinuteSelect" aria-label="Select minutes">
                <option value="">Minutes</option>
                <option value="00">:00</option>
                <option value="15">:15</option>
                <option value="30">:30</option>
                <option value="45">:45</option>
              </select>
            </div>
          </div>
          <div class="ampm-toggle" role="group" aria-label="Select AM or PM">
            <button type="button" class="active" data-period="AM">AM</button>
            <button type="button" data-period="PM">PM</button>
          </div>
          <input type="hidden" id="time" name="time">
        </div>

        <button type="submit" class="booking-submit">Book Appointment</button>
        </form>
      </div>

      <div id="bookingSuccess" class="booking-success" style="display:none; margin-top: 40px;" aria-live="polite">
        <div class="success-card">
          <div class="success-icon" aria-hidden="true">
            <span class="check-mark">✓</span>
          </div>
          <h2>Your appointment is confirmed!</h2>
          <p>Thank you for booking with Desert Shine Detailing.</p>
          <p>We’ll be in touch soon.</p>
          <button type="button" id="waiverCta" class="success-btn" aria-label="Fill out waiver">
            First time? Please fill out this waiver
          </button>
          <!-- Future: link this CTA to your waiver once available -->
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>&copy; <span id="year">2025</span> Desert Shine Detailing.</p>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="js/main.js"></script>
  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbyUIXPQmX6RDVx--mLqpFcBmTvHu83OkiYaa_sXpF_-3VronnfcmFqVItJlyzOc8ahhQg/exec";
  const toastEl = document.getElementById("toast");
  const dateField = document.getElementById("date");
  const timeField = document.getElementById("time");
  const timeDisplay = document.getElementById("timeDisplay");
  const hourSelect = document.getElementById("timeHourSelect");
  const minuteSelect = document.getElementById("timeMinuteSelect");
  const timeDropdowns = document.getElementById("timeDropdowns");
  const timeInputWrapper = document.querySelector(".time-input-wrapper");
  const periodButtons = document.querySelectorAll(".ampm-toggle button");
  const calendarButton = document.querySelector(".calendar-btn");
  const successSection = document.getElementById("bookingSuccess");
  const waiverCta = document.getElementById("waiverCta");
  const pad = value => String(value).padStart(2,"0");
  let availabilityAbortController = null;
  let dropdownOpen = false;
  let isSubmitting = false;

  const updateTimeValue = () => {
    if(!hourSelect.value || !minuteSelect.value){
      timeDisplay.value = "";
      timeField.value = "";
      return false;
    }
    const displayValue = `${hourSelect.value}:${minuteSelect.value}`;
    timeDisplay.value = displayValue;
    let hours24 = parseInt(hourSelect.value, 10) % 12;
    if((timeField.dataset.period || "AM") === "PM"){
      hours24 += 12;
    }
    timeField.value = `${pad(hours24)}:${minuteSelect.value}`;
    return true;
  };

  const checkAvailabilityIfReady = () => {
    if (isSubmitting) return;
    const hasTime = updateTimeValue();
    if (!dateField.value || !hasTime || !timeField.value) return;

    const params = new URLSearchParams({
      action: "check",
      date: dateField.value,
      time: timeField.value
    });

    if (availabilityAbortController) {
      availabilityAbortController.abort();
    }
    availabilityAbortController = new AbortController();

    fetch(`${scriptURL}?${params.toString()}`, {
      method: "GET",
      signal: availabilityAbortController.signal
    })
      .then(res => res.text())
      .then(text => {
        if (text.toLowerCase().includes("unavailable")) {
          showToast("That time is unavailable — please choose another slot.");
        }
      })
      .catch(err => {
        if (err.name === "AbortError") return;
        console.error("Availability check failed", err);
      });
  };

  const setPeriod = (period) => {
    periodButtons.forEach(btn => {
      const isActive = btn.dataset.period === period;
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-pressed", isActive ? "true" : "false");
    });
    timeField.dataset.period = period;
    updateTimeValue();
    checkAvailabilityIfReady();
  };

  periodButtons.forEach(btn => {
    btn.setAttribute("aria-pressed", btn.classList.contains("active") ? "true" : "false");
    btn.addEventListener("click", () => setPeriod(btn.dataset.period));
  });

  const openDropdowns = () => {
    dropdownOpen = true;
    timeDropdowns.classList.add("visible");
    timeDropdowns.setAttribute("aria-hidden", "false");
    if(timeInputWrapper){
      timeInputWrapper.classList.add("active");
    }
  };
  const closeDropdowns = () => {
    dropdownOpen = false;
    timeDropdowns.classList.remove("visible");
    timeDropdowns.setAttribute("aria-hidden", "true");
    if(timeInputWrapper){
      timeInputWrapper.classList.remove("active");
    }
  };

  timeDisplay.addEventListener("focus", openDropdowns);
  timeDisplay.addEventListener("click", () => {
    if(!dropdownOpen) openDropdowns();
  });

  hourSelect.addEventListener("change", () => {
    updateTimeValue();
    if(hourSelect.value && minuteSelect.value) closeDropdowns();
    checkAvailabilityIfReady();
  });
  minuteSelect.addEventListener("change", () => {
    updateTimeValue();
    if(hourSelect.value && minuteSelect.value) closeDropdowns();
    checkAvailabilityIfReady();
  });

  document.addEventListener("click", event => {
    if(!timeInputWrapper.contains(event.target)){
      closeDropdowns();
    }
  });

  dateField.addEventListener("keydown", e => e.preventDefault());
  dateField.addEventListener("keypress", e => e.preventDefault());
  dateField.addEventListener("paste", e => e.preventDefault());
  dateField.addEventListener("change", checkAvailabilityIfReady);
  if(calendarButton){
    calendarButton.addEventListener("click", () => {
      if(typeof dateField.showPicker === "function"){
        dateField.showPicker();
      }else{
        dateField.focus();
      }
    });
  }
  setPeriod("AM");

  const showToast = message => {
    toastEl.textContent = message;
    toastEl.classList.add("visible");
    setTimeout(() => toastEl.classList.remove("visible"), 3000);
  };

  const resetBookingUI = () => {
    bookingForm.reset();
    hourSelect.value = "";
    minuteSelect.value = "";
    timeDisplay.value = "";
    timeField.value = "";
    setPeriod("AM");
    closeDropdowns();
    bookingForm.style.display = "";
    if (successSection) {
      successSection.style.display = "none";
      successSection.classList.remove("visible");
    }
  };

  const showSuccessScreen = () => {
    const formCard = document.querySelector(".form-card");
    if (formCard) {
      formCard.style.display = "none";
    }
    const pageHead = document.querySelector(".page-head");
    if (pageHead) {
      pageHead.style.display = "none";
    }
    if (successSection) {
      successSection.style.display = "block";
      successSection.classList.add("visible");
    }
  };

  const bookingForm = document.getElementById("bookingForm");
  bookingForm.addEventListener("submit", e => {
    e.preventDefault();
    isSubmitting = true;
    if (availabilityAbortController) {
      availabilityAbortController.abort();
    }
    const hasValidTime = updateTimeValue();

    if (!hasValidTime) {
      showToast("Select an hour and minutes to continue.");
      return;
    }

    if (!bookingForm.checkValidity()) {
      bookingForm.reportValidity();
      return;
    }

    // Use URL-encoded form data for universal browser support
    const formData = new FormData(bookingForm);
    const payload = new URLSearchParams(formData);

    fetch(scriptURL, {
    method: "POST",
    body: payload
    })
      .then(async res => {
        const text = await res.text();
        if (text.includes("unavailable")) {
          showToast("That time is already taken — please choose another slot.");
        } else if (text.includes("confirmed")) {
          showSuccessScreen();
          isSubmitting = false;
          showToast("Booking confirmed! We'll email your confirmation soon.");
        } else {
      showToast(text || "Booking received.");
    }
  })
    .catch(() => showToast("Something went wrong. Please try again."));
});

// If you later link the waiver CTA to an external URL, set its href dynamically here.
  </script>
</body>
</html>
